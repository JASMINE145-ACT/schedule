# 商务接待行程规划服务 - 后端 + Streamlit 前端

## A. 任务目标

基于现有的 `jakarta_business_trip` 项目功能，构建一个通用的**商务接待行程规划服务系统**，包括后端 API 和 Streamlit 前端界面，专门用于商务拜访、客户接待等商务活动的行程规划。

**本系统专注于商务接待规划，而非旅游规划**，重点考虑：
- 商务会面地点选择（写字楼、商务区、工业园等）
- 交通高峰时段规避（避免延误商务会面）
- 交通风险评估（识别高风险路段和时间段）
- 住宿策略优化（权衡通勤时间和成本）
- 替代方案设计（应对突发情况）

**成功标准：**
- ✅ 后端提供稳定的 API 服务，支持商务行程规划请求
- ✅ Streamlit 前端提供友好的交互界面
- ✅ 集成 Google Maps API 获取真实地理数据
- ✅ 使用 Claude LLM 进行智能路线优化
- ✅ **生成商务接待风格的详细规划报告，包含交通风险评估**
- ✅ 前后端一致，功能完整可用
- ✅ 经过充分测试，无系统性错误
- ✅ 可以部署供他人使用

## B. 输入信息

### 参考项目分析

**现有功能（来自 `jakarta_business_trip`）：**
1. ✅ 使用 Google Maps MCP 工具：
   - `mcp_Google_Maps_geocode` - 地理编码（11次调用成功）
   - `mcp_Google_Maps_get_directions` - 路线规划（5次调用成功）
   - `mcp_Google_Maps_get_distance_matrix` - 距离矩阵（1次调用，49个距离对）
   - `mcp_Google_Maps_search_places` - 地点搜索（2次调用，20个地点）
2. ✅ 生成详细行程规划文档（`itinerary.md`）
3. ✅ 路线优化分析（考虑交通高峰、距离、折返）
4. ✅ 交通风险评估（识别高风险路段/时段）
5. ✅ 替代方案设计（精简版路线）
6. ✅ 住宿策略建议（权衡分析）

### 技术需求

**后端：**
- Python FastAPI 框架
- 集成 Google Maps MCP 工具
- 使用 Claude Haiku 3.5（通过 LangChain）
- 提供 RESTful API 端点
- 支持异步处理（长时间路线计算）

**前端：**
- Streamlit 框架
- 交互式表单输入（行程要求、约束条件）
- 实时显示规划进度
- 美观的报告展示
- 支持导出报告（Markdown/PDF）

**模型配置：**
- LLM: Claude Haiku 3.5 (`anthropic:claude-3-5-haiku-20241022`)
- 温度: 0.1（确保输出稳定）
- 最大 tokens: 4096

### 功能范围

**必须实现的功能（商务接待规划）：**
1. ✅ 地点地理编码（地址 → 坐标）
   - 商务地点：写字楼、商务区、工业园、会议室等
   - 住宿地点：商务酒店、会议中心附近
   - 餐饮地点：商务午餐、商务晚餐地点
2. ✅ 距离和时间计算（距离矩阵）
   - 考虑交通模式（包车、自驾、公共交通）
   - 区分高峰/非高峰时段
   - 计算单程车程，确保不超过2小时
3. ✅ 路线规划（起点 → 终点，考虑交通模式）
   - 包车路线优化（商务接待常用）
   - 避开早晚高峰（07:00-09:00，16:30-18:30）
   - 减少折返，形成闭环路线
4. ✅ 地点搜索（商务相关地点）
   - 商务会面区搜索
   - 工业园、商务区搜索
   - 商务午餐、商务晚餐地点
   - 商务酒店搜索
5. ✅ 路线优化（基于距离、时间、交通高峰）
   - 商务会面地点排序优化
   - 考虑地理位置的逻辑顺序
   - 预留机动缓冲时段
6. ✅ **交通风险评估（重点功能）**
   - 识别高风险路段和时间段
   - 标注可能拥堵的区域
   - 提供绕行或时间调整建议
   - 标注风险等级（高/中/低）
7. ✅ 替代方案生成（精简版路线）
   - 时间紧张时的删减方案
   - 住宿策略的权衡分析（A vs B）
   - 提前出发策略建议
8. ✅ **商务接待规划报告生成（Markdown 格式）**
   - 执行摘要（关键数据）
   - 每日详细行程（包含距离、时间、路线逻辑）
   - 交通风险评估总结（最高风险路段/时段）
   - 替代方案（精简路线、住宿策略）
   - 每日时间表建议
   - 关键建议总结

**可选功能：**
- 可视化地图显示（使用 Streamlit 地图组件）
- PDF 导出
- 历史行程保存
- 多城市支持

## C. 输出内容

### 后端 API 输出

1. **商务接待行程规划结果** (JSON)
   - 执行摘要（总天数、团队规模、交通方式、总距离、总行程时间）
   - 每日路线（起点、必去点、候选点、路线逻辑）
   - 时间安排建议（避开高峰、预留缓冲）
   - **距离和时间数据（详细：从A到B的距离、非高峰时间、高峰时间）**
   - **交通风险评估（高风险/中风险/低风险路段和时段，包含风险原因和缓解措施）**
   - **替代方案（精简版路线、住宿策略选择、提前出发策略）**
   - 每日时间表建议

2. **中间数据** (缓存)
   - 地理编码结果（地点坐标）
   - 距离矩阵（地点间距离和时间）
   - 路线详情（分段路线信息）

### 前端界面输出

1. **交互式表单**
   - 行程基本信息输入
   - 每日必去点和候选点
   - 约束条件设置

2. **规划结果展示**
   - 每日路线可视化
   - 时间表展示
   - 风险提示
   - 替代方案选择

3. **报告导出**
   - Markdown 格式
   - 可选 PDF 格式

### 文档输出

1. **API 文档** (`api_docs.md`)
2. **用户使用指南** (`USER_GUIDE.md`)
3. **部署说明** (`DEPLOYMENT.md`)
4. **测试报告** (`TEST_REPORT.md`)

## D. 执行步骤

### 阶段 1: 项目结构设计

1. **创建项目文件夹结构**
   ```
   analysis/travel_planner_service/
   ├── plan.md (本文件)
   ├── report.md (执行报告)
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py (FastAPI 应用)
│   │   ├── models.py (Pydantic 模型)
│   │   ├── database.py (SQLite 数据库)
│   │   ├── services/
│   │   │   ├── __init__.py
│   │   │   ├── maps_service.py (Google Maps MCP 封装)
│   │   │   ├── route_optimizer.py (路线优化逻辑)
│   │   │   ├── report_generator.py (报告生成)
│   │   │   └── llm_service.py (Claude 调用)
│   │   └── routers/
│   │       ├── __init__.py
│   │       ├── planning.py (规划 API 路由)
│   │       └── history.py (历史记录路由)
│   ├── requirements.txt
│   └── .env.example
   ├── frontend/
   │   ├── app.py (Streamlit 主应用)
   │   ├── pages/ (可选：多页面)
   │   ├── components/ (可复用组件)
   │   │   ├── form_input.py
   │   │   ├── result_display.py
   │   │   └── map_view.py
   │   └── requirements.txt
   ├── tests/
   │   ├── test_backend.py
   │   ├── test_frontend.py
   │   └── test_integration.py
   └── docs/
       ├── api_docs.md
       ├── USER_GUIDE.md
       └── DEPLOYMENT.md
   ```

### 阶段 2: 后端开发

2. **核心服务实现**
   - `maps_service.py`: 封装 Google Maps MCP 调用
     - 地理编码（geocode）
     - 路线规划（get_directions）
     - 距离矩阵（get_distance_matrix）
     - 地点搜索（search_places）
   - `llm_service.py`: Claude Haiku 3.5 调用
     - 路线优化建议生成
     - 风险评估分析
     - 替代方案生成
   - `route_optimizer.py`: 路线优化核心逻辑
     - 基于距离矩阵的路线排序
     - 交通高峰时段过滤
     - 折返路径检测
   - `report_generator.py`: Markdown 报告生成
     - 格式化输出
     - 包含数据源引用

3. **FastAPI 应用**
   - `/api/health` - 健康检查
   - `/api/plan` - 行程规划主端点
   - `/api/geocode` - 地理编码端点
   - `/api/directions` - 路线规划端点
   - `/api/distance-matrix` - 距离矩阵端点

4. **错误处理**
   - MCP 工具失败回退机制
   - API 限流处理
   - 输入验证

### 阶段 3: 前端开发

5. **Streamlit 界面**
   - 首页：功能介绍
   - 规划页面：表单输入 + 结果展示
   - 历史记录页面（可选）

6. **表单组件**
   - 基本信息输入（团队规模、交通方式、天数）
   - 每日行程配置（必去点、候选点、约束）
   - 高级选项（交通高峰设置、缓冲时间）

7. **结果展示组件**
   - 每日路线卡片
   - 时间表可视化
   - 地图显示（Streamlit map）
   - 风险提示面板
   - 导出按钮

### 阶段 4: 集成与测试

8. **前后端集成**
   - Streamlit 调用后端 API
   - 错误处理和重试机制
   - 加载状态显示

9. **功能测试**
   - 单元测试（后端服务）
   - 集成测试（前后端联调）
   - 端到端测试（完整流程）
   - 使用 jakarta_business_trip 的测试用例验证

10. **性能测试**
    - API 响应时间
    - 并发处理能力
    - 长时间路线计算的异步处理

### 阶段 5: 文档与部署

11. **文档编写**
    - API 文档
    - 用户使用指南
    - 部署说明
    - 故障排查指南

12. **部署准备**
    - Docker 化（可选）
    - 环境变量配置
    - 启动脚本

## E. 工具/依赖

### 后端依赖

```txt
# Web 框架
fastapi==0.115.12
uvicorn==0.34.2
pydantic==2.11.9

# LLM
langchain==0.3.19
langchain-core==0.3.45
langchain-anthropic>=0.3.0

# 工具
python-dotenv==1.1.1
httpx==0.27.2  # 用于异步 HTTP 请求

# 数据处理
pandas==2.2.3
```

### 前端依赖

```txt
streamlit==1.39.0
streamlit-folium==0.20.0  # 地图可视化
requests==2.32.3  # 调用后端 API
```

### MCP 工具

- `mcp_Google_Maps_geocode` - 地理编码
- `mcp_Google_Maps_get_directions` - 路线规划
- `mcp_Google_Maps_get_distance_matrix` - 距离矩阵
- `mcp_Google_Maps_search_places` - 地点搜索
- `mcp_Google_Maps_get_place_details` - 地点详情

### 环境变量

```env
# LLM
ANTHROPIC_API_KEY=your_key_here

# Google Maps (通过 MCP 配置)
# 注意：Google Maps API Key 在 MCP 配置中，不需要在 .env 中
```

### 备用方案

**如果 MCP 工具失败：**
1. 直接调用 Google Maps API（使用 `googlemaps` Python 库）
2. 使用缓存的地理数据（如果可用）

## F. 关键决策点

### 决策 1: MCP 工具封装方式

**选择：** 创建统一的 `maps_service.py` 封装所有 MCP 调用

**理由：**
- 统一错误处理
- 易于测试和替换（如果需要改用直接 API 调用）
- 代码复用

### 决策 2: LLM 使用策略

**选择：** 使用 Claude Haiku 3.5 进行路线优化建议生成

**理由：**
- 成本效益高（Haiku 比 Sonnet 便宜）
- 对于结构化路线规划任务足够准确
- 响应速度快

**使用场景：**
- 路线优化建议（基于距离矩阵数据）
- 风险评估分析
- 替代方案生成
- 报告文本生成

### 决策 3: 前后端通信方式

**选择：** Streamlit 通过 HTTP 调用后端 FastAPI

**理由：**
- 前后端解耦，可以独立部署
- 后端可以被其他客户端复用
- 便于测试和调试

### 决策 4: 异步处理策略

**选择：** 长时间路线计算使用 FastAPI 后台任务 + 轮询

**理由：**
- 避免请求超时
- 提供进度反馈
- 支持取消操作

## G. 风险/边界情况

### 技术风险

1. **MCP 工具失败或超时**
   - **风险：** 无法获取地理数据
   - **缓解：** 
     - 实现回退机制（直接调用 Google Maps API）
     - 添加重试逻辑
     - 使用缓存

2. **LLM API 限流**
   - **风险：** Claude API 请求被限流
   - **缓解：**
     - 实现请求队列
     - 添加指数退避重试
     - 限制并发请求数

3. **长时间计算超时**
   - **风险：** 复杂路线计算超过 HTTP 超时时间
   - **缓解：**
     - 使用异步后台任务
     - 分阶段处理（地理编码 → 距离计算 → 优化 → 报告生成）
     - 提供进度反馈

### 数据质量风险

1. **地点定位不准确**
   - **风险：** 地理编码返回错误位置
   - **缓解：** 
     - 提供地点确认步骤
     - 显示地图预览
     - 允许用户手动调整坐标

2. **交通时间估算偏差**
   - **风险：** Google Maps 时间估算与实际不符
   - **缓解：**
     - 标注数据来源和估算方法
     - 提供保守估计（预留缓冲时间）
     - 区分高峰和非高峰时间

### 用户体验风险

1. **界面响应慢**
   - **风险：** 等待时间长，用户体验差
   - **缓解：**
     - 分阶段加载（先显示地理编码结果，再计算距离）
     - 显示加载进度
     - 使用缓存减少重复计算

## H. 验收标准

### 功能验收

- [ ] **后端 API 正常响应**
  - 健康检查端点返回 200
  - 规划端点能够处理请求并返回结果
  - 所有端点都有适当的错误处理

- [ ] **Google Maps 集成正常**
  - 地理编码功能正常
  - 距离矩阵计算准确
  - 路线规划返回有效结果
  - 地点搜索能够找到相关地点

- [ ] **LLM 集成正常**
  - Claude Haiku 3.5 能够正常调用
  - 生成的内容符合预期
  - 响应时间在合理范围内（< 10秒）

- [ ] **路线优化功能正常**
  - 能够基于距离矩阵优化路线顺序
  - 考虑交通高峰时段
  - 识别折返路径并提供优化建议

- [ ] **报告生成功能正常**
  - 生成的 Markdown 报告结构清晰
  - 包含所有必需信息（路线、时间、风险、替代方案）
  - 数据来源清晰标注

- [ ] **Streamlit 前端正常**
  - 表单输入功能正常
  - 能够调用后端 API
  - 结果展示美观清晰
  - 导出功能正常

### 质量验收

- [ ] **测试覆盖率 > 80%**
  - 单元测试覆盖核心服务
  - 集成测试覆盖前后端交互
  - 端到端测试覆盖完整流程

- [ ] **无系统性错误**
  - 所有测试通过
  - 无明显 bug
  - 错误处理完善

- [ ] **性能满足要求**
  - API 响应时间 < 5秒（简单请求）
  - 复杂规划请求 < 30秒
  - 前端界面响应流畅

- [ ] **文档完整**
  - API 文档完整准确
  - 用户使用指南清晰易懂
  - 部署说明详细

### 可用性验收

- [ ] **能够复现 jakarta_business_trip 的规划结果**
  - 使用相同的输入参数
  - 生成的结果质量相当或更好

- [ ] **新用户能够独立使用**
  - 界面直观易用
  - 文档清晰
  - 错误提示友好

## I. 项目范围边界

### 包含

- ✅ 后端 FastAPI 服务（核心规划功能）
- ✅ Streamlit 前端界面（交互式规划工具）
- ✅ Google Maps MCP 集成（地理数据获取）
- ✅ Claude Haiku 3.5 集成（智能优化）
- ✅ 报告生成（Markdown 格式）
- ✅ 基础测试（单元测试、集成测试）
- ✅ 文档（API 文档、用户指南、部署说明）

### 已更新（基于用户反馈）

- ✅ **数据库持久化**：使用 SQLite 保存每次规划结果
- ✅ **可视化地图**：使用 streamlit-folium 显示路线地图
- ✅ **历史记录管理**：查看和重新加载历史规划

### 不包含（第一版）

- ❌ 用户认证和授权（单用户使用）
- ❌ PDF 导出（仅 Markdown）
- ❌ 多语言支持（仅中文）

## J. 可交付成果清单

1. ✅ `plan.md` - 本规划文档（当前文件）
2. ⏳ `backend/` - 后端代码（FastAPI 应用）
3. ⏳ `frontend/` - 前端代码（Streamlit 应用）
4. ⏳ `tests/` - 测试代码
5. ⏳ `docs/` - 文档
6. ⏳ `requirements.txt` - 依赖列表
7. ⏳ `report.md` - 执行报告
8. ⏳ `TEST_REPORT.md` - 测试报告

## K. 重现性计划

### 开发环境

```bash
# 1. 克隆或进入项目目录
cd analysis/travel_planner_service

# 2. 安装后端依赖
cd backend
pip install -r requirements.txt

# 3. 安装前端依赖
cd ../frontend
pip install -r requirements.txt

# 4. 配置环境变量
# 复制 .env.example 到 .env，填入 ANTHROPIC_API_KEY

# 5. 启动后端服务
cd ../backend
uvicorn app.main:app --reload --port 8000

# 6. 启动前端服务（新终端）
cd frontend
streamlit run app.py
```

### 测试

```bash
# 运行单元测试
pytest tests/test_backend.py -v

# 运行集成测试
pytest tests/test_integration.py -v

# 运行所有测试
pytest tests/ -v
```

### 验证

使用 `jakarta_business_trip` 的测试用例验证功能：
1. 输入相同的行程要求
2. 验证生成的报告质量
3. 对比关键指标（距离、时间、风险识别）

---

**等待用户批准后开始执行**

**问题/澄清：**
1. 是否需要支持多用户（用户认证）？ 单用户
2. 是否需要数据库持久化（SQLite/PostgreSQL）？需要每次的规划 要保存
3. 是否需要可视化地图（folium/leaflet）？可以
4. 部署方式偏好（本地/Docker/云服务）？streamlit官方的云服务就行

